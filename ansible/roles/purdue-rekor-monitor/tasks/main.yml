---
- name: Make sure required services are running
  systemd:
    state: started
    name: "{{ item }}"
  with_items:
    - docker
    - nginx-reverse
    - acme-companion

- name: Copy monitor service files
  copy:
    src: "{{ item.service }}"
    dest: /etc/systemd/system
    owner: core
    mode: 0644
  register: monitor_services
  notify:
    - Restart monitor services
  with_items:
    - { service: 'monitor-db.service' }
    - { service: 'monitor-mirror.service' }
    - { service: 'monitor-backend.service' }
    - { service: 'monitor-frontend.service' }
    - { service: 'monitor-proxy.service' }

- name: Start monitor service
  systemd:
    name: "{{ item }}"
    enabled: true
    state: started
    daemon-reload: true
  with_items:
    - monitor-db.service
    - monitor-mirror.service
    - monitor-backend.service
    - monitor-frontend.service
    - monitor-proxy.service
